#!/bin/bash

VIM_PATCH="${PWD}/myfiles/molokai.vim"
NETWORK_PATCH="${PWD}/myfiles/luci-network.patch"
DOCKER_PATCH="${PWD}/myfiles/docker.patch"

my_adjust_samba_config() {
    echo "è°ƒæ•´ samba server é…ç½® ..."
    (
        # for cifsd
        if [ -f ./etc/init.d/cifsd ];then
            echo -n "å‘ç° cifsd, ç¦ç”¨ samba4. "        
            rm -f ./etc/rc.d/S98samba4
        fi
        # for smbd
        if [ -f ./etc/init.d/smbd ];then
            echo -n "å‘ç° smbd, ç¦ç”¨ samba4. "        
            rm -f ./etc/rc.d/S98samba4
        fi                
        # for ksmbd
        if [ -f ./etc/init.d/ksmbd ];then
            echo -n "å‘ç° ksmbd, ç¦ç”¨ samba4. "        
            rm -f ./etc/rc.d/S98samba4
            sed -e 's/modprobe ksmbd/sleep 1 \&\& modprobe ksmbd/' -i ./etc/init.d/ksmbd
        fi
        # for samba4 enable smbv1 protocol
        if [ -f ./etc/config/samba4 ];then
            echo "å‘ç° samba4, å°†å¯ç”¨ smbv1 åè®®. "        
            [ -f ${SMB4_PATCH} ] && patch -p1 < ${SMB4_PATCH}
        fi
    )
    echo "å®Œæˆ"
    echo
}

patch_vimrc() {
    echo "è°ƒæ•´ vim é…ç½® ..."
	if [ -f $VIM_PATCH ];then
		cp -f $VIM_PATCH ./usr/share/vim/vim??/colors/
		sed -i '1 i\colorscheme molokai' ./usr/share/vim/vimrc
		cat >> ./usr/share/vim/vimrc <<EOF
set tabstop=2
set shiftwidth=4
set expandtab
set softtabstop=4
EOF
	fi
}

my_write_banner() {
    echo "å†™å…¥ banner ä¿¡æ¯ ... "
    (
        cd $TGT_ROOT
        if [ -f $BANNER ];then
            cp -f $BANNER ./etc/banner
            echo " -----------------------------------" >> etc/banner
            echo " [33mLEDE ${OPENWRT_VER} ${KERNEL_VERSION}[0m" >> etc/banner
            echo >> etc/banner
        fi
    )
    cat $TGT_ROOT/etc/banner
    echo
}

immortalwrt_banner() {
    echo "å†™å…¥ banner ä¿¡æ¯ ... "
    (
        cd $TGT_ROOT
        if [ -f $BANNER ];then
            cp -f $BANNER ./etc/banner
            echo " ----------------------------------------" >> etc/banner
            echo " [33mOpenwrt-18.06 ${KERNEL_VERSION} ${OPENWRT_VER}[0m" >> etc/banner
            echo >> etc/banner
        fi
    )
    cat $TGT_ROOT/etc/banner
    echo
}   

immortalwrt_profile() {
    echo "è°ƒæ•´ profile é…ç½® ... "
    cd $TGT_ROOT
    if [[ -f ./etc/profile ]]; then
        rmLine=$(cat ./etc/profile | grep -n alF | head -1 | cut -d : -f 1)
        sed -i "${rmLine}d" ./etc/profile
}

patch_luci_network() {
    echo "ä¿®å¤æ¥å£çŠ¶æ€æ˜¾ç¤ºé”™è¯¯"
    (
        cd $TGT_ROOT
        if [ -f "${NETWORK_PATCH}" ];then
            patch -p1 < ${NETWORK_PATCH}
            if [ $? -ne 0 ];then
                echo "ä¿®å¤å¤±è´¥"
            fi
        fi
        echo "å®Œæˆ"
        echo
    )
}

immortalwrt_docker_config() {
    echo "è°ƒæ•´ docker server é…ç½® ... "
    (
        cd $TGT_ROOT
        [ -n "$DOCKER_README" ] && [ -f ./www/DockerReadme.pdf ] && [ -f ${DOCKER_README} ] && cp -fv ${DOCKER_README} ./www/DockerReadme.pdf
        if [ -f ./etc/init.d/docker ];then
            echo "å‘ç° docker æœåŠ¡ï¼Œæ­£åœ¨è°ƒæ•´ ... "
            [ -n "$DOCKERD_PATCH" ] && [ -f "$DOCKERD_PATCH" ] && [ ! -f ./etc/init.d/dockerman ] && patch -p1 < $DOCKERD_PATCH

            if [ -f "./etc/init.d/dockerman" ] ;then
                cat >> ./etc/config/dockerd <<EOF

config globals 'globals'
        option alt_config_file '/etc/docker/daemon.json' 
    option auto_start '1'
EOF
                sed -e '/uci -q set dockerd.globals.auto_start="0"/d' -i ./etc/uci-defaults/luci-app-dockerman 
            fi

        # ç”±first_run.shè´Ÿè´£é‡æ–°å¼€å¯dockeræœåŠ¡
            echo "é»˜è®¤å…³é—­ docker æœåŠ¡ ... "
            rm -f ./etc/rc.d/S??docker ./etc/rc.d/S??dockerman
            echo "å®Œæˆ"
        else
            echo "æœªå‘ç° docker æœåŠ¡ï¼Œæ”¾å¼ƒè°ƒæ•´"
        fi
    )
    echo
}

immortalwrt_firewall_custom(){
    echo "æ·»åŠ  docker é˜²ç«å¢™è§„åˆ™... "
    cd $TGT_ROOT
    [ -f ./etc/firewall.user ] && echo -e "\niptables -t nat -A POSTROUTING -s 172.31.0.0/16 ! -o docker0 -j MASQUERADE" >> ./etc/firewall.user
    echo "å®Œæˆ"
}

adjust_openwrt_kernel() {
    echo "è°ƒæ•´ openwrt-kernel ..."
    cd $TGT_ROOT
    if [ -f ./usr/sbin/openwrt-kernel ];then
        sed -i '/# Update release file/a\    flippy_ver=$(uname -r)' ./usr/sbin/openwrt-kernel
        sed -i 's| Kernel.*/ Kernel: |${flippy_ver}/|' ./usr/sbin/openwrt-kernel
    fi
    echo "å®Œæˆ"
}